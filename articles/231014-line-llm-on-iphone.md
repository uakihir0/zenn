---
title: "LINE ã® LLM ã‚’ iPhone ã§å‹•ã‹ã—ãŸè©±"
emoji: "ğŸ“²"
type: "tech"
topics: ["ChatGPT", "llm", "ml"]
published: true
---

# ã¯ã˜ã‚ã«

**æ˜¨ä»Š ChatGPT ã‚’ã¯ã˜ã‚ã¨ã™ã‚‹ç”Ÿæˆ AI ã«ã¤ã„ã¦ã‚‚é€²åŒ–ãŒå‡„ã¾ã˜ã**ã€ä»Šã¾ã§ç°¡å˜ã«ã¯ã§ããªã‹ã£ãŸã“ã¨ã€äººæ‰‹ãŒå¿…è¦ã ã£ãŸã“ã¨ãŒã©ã‚“ã©ã‚“ AI ã«ã‚ˆã£ã¦è‡ªå‹•åŒ–ã•ã‚Œã¦ã„ã¾ã™ã€‚ãã‚“ãªä¸­ **ã‚¨ãƒƒã‚¸ (ã‚ªãƒ³ãƒ‡ãƒã‚¤ã‚¹) ã§ã® AI å‡¦ç†ãŒæµè¡Œã‚‹æ°—é…ã‚’è¦‹ã›ã¤ã¤ã‚ã‚Šã¾ã™**ã€‚æœ€è¿‘ç™ºè¡¨ã•ã‚ŒãŸ Google ã® Pixel8 ã§ã¯ã€ç«¯æœ«ã®ãƒ‘ãƒ¯ãƒ¼ã‚’ç”¨ã„ã¦ AI ã®æŠ€è¡“ã§å†™çœŸã‚’æ›¸ãæ›ãˆã¦ã€ã‚ˆã‚Šè‰¯ã„ã‚‚ã®ã«å¤‰æ›´ã—ã¦ã„ã£ãŸã‚Šãªã©ã€ã‚¨ãƒƒã‚¸ã§ã® AI å‡¦ç†ã®æœ‰ç”¨æ€§ã‚’ç¤ºã—ã¦ãã‚Œã¾ã—ãŸã€‚ä»Šå›ã€è‡ªåˆ†ã¯ãã®ä¸­ã®ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã¨ã—ã¦ã€iPhone ã®ç«¯æœ«ä¸Šã ã‘ã§ LLM (å¤§è¦æ¨¡è¨€èªãƒ¢ãƒ‡ãƒ«) ã‚’å‹•ä½œã•ã›ã¦ä½•ã‹ã‚’ä½œã‚Œãªã„ã‹ã‚’è€ƒãˆã¦ã¿ã‚ˆã†ã¨æ€ã„ã€èª¿æŸ»ã‚‚å…¼ã­ã¦å®Ÿéš›ã«å‹•ä½œã•ã›ã‚‹ã¨ã“ã‚ã¾ã§è©¦ã—ãŸã®ã§ã€ãã®å†…å®¹ã‚’å…±æœ‰ã—ã¾ã™ã€‚

ã¾ãŸã€ã“ã®è¨˜äº‹ã‚’æ›¸ã„ã¦ã„ã‚‹æœ¬äººã¯ã€ã“ã®åˆ†é‡ã«ã¤ã„ã¦ã®çŸ¥è­˜ã¯ã»ã¼ãªã„ã®ã§ã€è‰²ã€…é–“é•ã£ã¦ã„ã‚‹éƒ¨åˆ†ãŒã‚ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚ãã®å ´åˆã¯ã€ã‚³ãƒ¡ãƒ³ãƒˆç­‰ã§æŒ‡æ‘˜ã—ã¦ã„ãŸã ã‘ã‚‹ã¨å¹¸ã„ã§ã™ã€‚

## çµè«–

å…ˆã«çµè«–ã‚’è¿°ã¹ã¦ãŠãã¨ã€**ç¾çŠ¶ã«ãŠã‘ã‚‹ LLM ã®ã‚ªãƒ³ãƒ‡ãƒã‚¤ã‚¹å‹•ä½œã¯ã¾ã ã¾ã ç™ºå±•é€”ä¸Šã§ã€æœ‰ç”¨ãªæ´»ç”¨æ³•ãŒæ¤œè¨ã§ãã‚‹ãƒ¬ãƒ™ãƒ«ã§ã¯ãªã•ãã†** ã¨ã„ã†ã®ãŒçµè«–ã§ã™ã€‚ã“ã‚Œã¯æ—¥æœ¬èªã®è©±ãªã®ã§è‹±èªã ã¨ã‚‚ã†å°‘ã—ç•°ãªã£ã¦ãã‚‹å¯èƒ½æ€§ã‚‚ã‚ã‚‹ã®ã‹ãªã¨æ€ã„ã¾ã™ã€‚

https://twitter.com/uakihir0/status/1711010276869570902

## LINE ã® LLM

ä»Šå› iPhone ã§å‹•ä½œã•ã›ã‚‹ã“ã¨ã‚’ç›®æ¨™ã«ã—ãŸãƒ¢ãƒ‡ãƒ«ãŒ LINE ãŒå…¬é–‹ã—ã¦ã„ã‚‹ LLM ã§ã™ã€‚

https://engineering.linecorp.com/ja/blog/3.6-billion-parameter-japanese-language-model

ã“ã®ãƒ¢ãƒ‡ãƒ«ã®è©³ç´°ã«ã¤ã„ã¦ã¯ä¸Šè¨˜ãƒªãƒ³ã‚¯ã‹ã‚‰è¦‹ã¦ã„ãŸã ããŸã„ã§ã™ãŒã€ã¨ã¦ã‚‚æ—¥æœ¬èªè¨€èªãƒ¢ãƒ‡ãƒ«ã¨ã—ã¦ã¯æœ‰ç”¨ãã†ã«è¦‹ãˆã¾ã™ã€‚ä¸€æ–¹ã§ 36 å„„ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¨ã„ã†ã®ã¯ã¡ã‚‡ã£ã¨å¿ƒç´°ãã€ChatGPT ã¯ 100 å…†ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¨è¨€ã‚ã‚Œã¦ã„ã‚‹ã®ã§ãã®è¦æ¨¡ã®é•ã„ãŒè¦‹ã¦å–ã‚Œã¾ã™ã€‚ã“ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ•°ã®å·®ç•°ã¯ä¸»ã«ã€ã‚¨ãƒƒã‚¸ã§å‹•ã‹ã™ã‹ã€ã‚¯ãƒ©ã‚¦ãƒ‰ã§å‹•ã‹ã™ã®ã‹ã®å·®ãŒã‚ã‚Šã€ã“ã® LINE ã® LLM ã¯ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä¿æŒã™ã‚‹ç«¯æœ«ã§ã‚‚å‹•ã‹ã™ã“ã¨ãŒå¯èƒ½ãªãƒ¬ãƒ™ãƒ«ã®ã‚‚ã®ã¨ãªã£ã¦ã„ã¾ã™ã€‚

## å…ˆè¡Œäº‹ä¾‹

ã“ã®è¨˜äº‹ã¯ä»¥ä¸‹ã®ãƒšãƒ¼ã‚¸ã«ã‚‚ã£ã¨ãƒ•ã‚©ãƒ¼ã‚«ã‚¹å½“ã¦ã¦æ¬²ã—ã„ã¨ã„ã†å´é¢ãŒã‚ã‚Šã¾ã™ã€‚ã“ã®æ–¹ã¯ã€LINE ã®ãƒ¢ãƒ‡ãƒ«ãŒå‡ºã‚‹ä»¥å‰ã«å‡ºã¦ã„ãŸ rinna ã®ãƒ¢ãƒ‡ãƒ«ã«ã¤ã„ã¦åŒæ§˜ã« iPhone ã§å‹•ã‹ã—ã¦ã„ã¾ã™ã€‚ã“ã®è¨˜äº‹ã®å†…å®¹ã¯æœ¬å½“ã«å‚è€ƒã«ãªã‚Šã¾ã—ãŸã€‚

- [rinna-3.6b ã‚’ mlc-llm ã‚’ä½¿ã£ã¦ Mac ã§å‹•ã‹ã™](https://zenn.dev/kkatsuyoshi/articles/916ae1db24c9ec)
- [rinna-3.6b ã‚’ iPhone ã§ã‚‚å‹•ã‹ã™](https://zenn.dev/kkatsuyoshi/articles/b29bf21081278a)

## ãƒ¢ãƒ‡ãƒ«

https://huggingface.co/uakihir0/japanese-large-lm-3.6b-instruction-sft-q4f16_0

**å…ˆã« iPhone å‘ã‘ã« LINE ã® LLM ã‚’ mlc-llm ã«ã‚ˆã£ã¦å¤‰æ›ã—ãŸ (é‡å­åŒ–ã—ãŸ) ãƒ¢ãƒ‡ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ç½®ã„ã¦ãŠãã¾ã™ã€‚** ã“ã®ãƒ¢ãƒ‡ãƒ«ã‚’ mlc-llm ã® iOS ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«çµ„ã¿è¾¼ã‚€ã¨å‹•ä½œç¢ºèªãŒã§ãã‚‹ã¨æ€ã„ã¾ã™ã€‚ãƒ¢ãƒ‡ãƒ«ãƒ‡ãƒ¼ã‚¿ã®ä½œæˆæ–¹æ³•ã«ã¤ã„ã¦ã¯ã€å…ˆè¡Œäº‹ä¾‹ã‚’å‚è€ƒã«ã—ãŸã®ã§ã€åˆã‚ã›ã¦è¦‹ã¦ã„ãŸã ãã¨åˆ†ã‹ã‚Šã‚„ã™ã„ã¨æ€ã„ã¾ã™ã€‚æ–­ç‰‡çš„ã«æ›¸ã„ã¦ã„ã‚‹ã®ã§ã€å®Ÿè¡Œã™ã‚‹ç’°å¢ƒã®ã‚ˆã£ã¦å¤‰ãˆã¦ã‚‚ã‚‰ãˆã‚Œã°ã¨æ€ã„ã¾ã™ã€‚

### ç’°å¢ƒæ•´å‚™

```shell
// Install tools
brew install python cmake rustup-init git git-lfs

// Git clone mmlc-llm
git clone --recursive https://github.com/mlc-ai/mlc-llm.git
cd mlc-llm

// Setup python environment
python3 -m venv myenv
source ./myenv/bin/activate
pip install torch transformers sentencepiece protobuf
pip install -I mlc_ai_nightly -f https://mlc.ai/wheels

// Setyp rust environment
rustup-init
source "$HOME/.cargo/env"
```

### ã‚³ãƒ¼ãƒ‰ã®å¤‰æ›´

```diff python:./mlc_llm/relax_model/gpt_neox.py
         ffn_out_dtype = "float16"
     elif model.lower().startswith("redpajama-"):
         stop_tokens = [0]
+    elif model.startswith("japanese-large-"):
+        stop_tokens = [3, 0]
+        ffn_out_dtype = "float16"
     else:
         raise ValueError(f"Unsupported model {model}")
```

```diff python:./mlc_llm/utils.py
        "stablelm-": "stablelm",
        "redpajama-": "redpajama_chat",
+       "japanese-large-": "line_llm",
        "minigpt": "minigpt",
        "moss-moon-003-sft": "moss",
```

```diff cpp:./mlc-llm/cpp/conv_templates.cc
+ Conversation LineLLM() {
+   Conversation conv;
+   conv.name = "line_llm";
+   conv.system = "";
+   conv.roles = {"ãƒ¦ãƒ¼ã‚¶ãƒ¼", "ã‚·ã‚¹ãƒ†ãƒ "};
+   conv.messages = {};
+   conv.separator_style = SeparatorStyle::kSepRoleMsg;
+   conv.offset = 0;
+   conv.seps = {"<NL>"};
+   conv.role_msg_sep = ": ";
+   conv.role_empty_sep = ":";
+   conv.stop_str = "</s>";
+   // TODO(mlc-team): add eos to mlc-chat-config
+   // and remove eos from stop token setting.
+   conv.stop_tokens = {3, 0};
+   conv.add_bos = false;
+   return conv;
+ }

...

      {"conv_one_shot", ConvOneShot},
      {"redpajama_chat", RedPajamaChat},
+     {"line_llm", LineLLM},
      {"rwkv_world", RWKVWorld},
      {"rwkv", RWKV},
```

### ãƒ¢ãƒ‡ãƒ«ã®é‡å­åŒ–

å…ˆã« Mac å‘ã‘ã«é‡å­åŒ–ãŒã§ãã‚‹ã‹ã©ã†ã‹ã‚’ç¢ºèªã—ã¾ã™ã€‚

```shell
python build.py          \
    --quantization q0f16 \
    --hf-path=line-corporation/japanese-large-lm-3.6b-instruction-sft
```

```shell
python3 build.py                                    \
    --model japanese-large-lm-3.6b-instruction-sft  \
    --quantization q4f16_0                          \
    --target iphone                                 \
    --max-seq-len 768
```

### ãƒˆãƒ¼ã‚¯ãƒ³ã®å‡¦ç†

`tokenizer.json` ã‚’ä½œæˆã—ã¾ã™ã€‚

```
python3 -c "import transformers; tokenizer=transformers.AutoTokenizer.from_pretrained('line-corporation/japanese-large-lm-3.6b-instruction-sft'); tokenizer.save_pretrained('tokenizer', legacy_format=False)"
cp tokenizer/tokenizer.json dist/japanese-large-lm-3.6b-instruction-sft-q0f16/params/
```

### iOS å‘ã‘ã«ãƒ¢ãƒ‡ãƒ«ã‚’é…ç½®

iOS ã‚¢ãƒ—ãƒªãŒèª­ã¿è¾¼ã‚€ãƒ¢ãƒ‡ãƒ«ãƒªã‚¹ãƒˆã‚’æ›´æ–°ã—ã¾ã™ã€‚

```diff json:./ios/MLCChat/app-config.json
 {
     "model_libs": [
-        "vicuna-v1-7b-q3f16_0",
-        "RedPajama-INCITE-Chat-3B-v1-q4f16_0"
+        "japanese-large-lm-3.6b-instruction-sft-q4f16_0"
     ],
     "model_list": [
         {
-            "model_url": "https://huggingface.co/mlc-ai/mlc-chat-vicuna-v1-7b-q3f16_0/resolve/main/",
-            "local_id": "vicuna-v1-7b-q3f16_0"
+            "model_url": "",
+            "local_id": "japanese-large-lm-3.6b-instruction-sft-q4f16_0"
         }
     ],
     "add_model_samples": [
-        {
-            "model_url": "https://huggingface.co/mlc-ai/mlc-chat-RedPajama-INCITE-Chat-3B-v1-q4f16_0/resolve/main/",
-            "local_id": "RedPajama-INCITE-Chat-3B-v1-q4f16_0"
-        }
     ]
 }
```

```diff sh:./ios/prepare_params.sh
 declare -a builtin_list=(
-    "RedPajama-INCITE-Chat-3B-v1-q4f16_0"
+    "japanese-large-lm-3.6b-instruction-sft-q4f16_0"
+    # "RedPajama-INCITE-Chat-3B-v1-q4f16_0"
     # "vicuna-v1-7b-q3f16_0"
```

ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ã€ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ãƒ“ãƒ«ãƒ‰ã¨ãƒ¢ãƒ‡ãƒ«ã®ã‚³ãƒ”ãƒ¼ã‚’è¡Œã„ã¾ã™ã€‚

```shell
cd ios
./prepare_libs.sh
./prepare_params.sh
```

`tokenizer.json` ã®ã‚³ãƒ”ãƒ¼ã‚’è¡Œã„ã¾ã™ã€‚

```shell
cp ../tokenizer/tokenizer.json dist/japanese-large-lm-3.6b-instruction-sft-q4f16_0
```

ã“ã“ã¾ã§ã§ä½œæˆã•ã‚ŒãŸãƒ¢ãƒ‡ãƒ«ãŒã€ `./ios/dist/japanese-large-lm-3.6b-instruction-sft-q4f16_0` ä»¥ä¸‹ã«é…ç½®ã•ã‚Œã¦ã„ã¾ã™ã€‚ã“ã‚Œã‚’ä¸Šã’ãŸã‚‚ã®ãŒ [ã“ã®ãƒ¬ãƒã‚¸ãƒˆãƒª](https://huggingface.co/uakihir0/japanese-large-lm-3.6b-instruction-sft-q4f16_0) ã«ãªã‚Šã¾ã™ã€‚ã“ã“ã¾ã§å®Ÿè¡Œã§ãã‚Œã°ã€ã‚ã¨ã¯ `./ios` ã«å«ã¾ã‚Œã¦ã„ã‚‹ iOS ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ç«‹ã¡ä¸Šã’ã¦ã€è«¸ã€…è¨­å®šã—ãŸä¸Šã§å®Ÿè¡Œã™ã‚Œã°å‹•ä½œã™ã‚‹ã¨æ€ã„ã¾ã™ã€‚

## çµè«–

ã“ã®ã‚ˆã†ã«ã€ã¨ã‚Šã‚ãˆãšã€iPhone ã§å‹•ã‹ã™ã“ã¨ã¯ã§ãã¾ã—ãŸãŒã€é‡å­åŒ–ã®éç¨‹ã®ä¸­ã§ç²¾åº¦ãŒè½ã¡ã¦ã„ã‚‹ã®ã‹ã€ã‹ãªã‚Šå—ã‘ç­”ãˆã«ã¯é›£ãŒã‚ã‚‹å½¢ã«ãªã‚Šã¾ã—ãŸã€‚æ”¹ã‚ã¦ã€è‡ªåˆ†ã¯ã“ã®åˆ†é‡ã«ã¤ã„ã¦ã®çŸ¥è­˜ã¯ã‚ã¾ã‚Šãªã„ã®ã§ã€ã“ã‚ŒãŒä»Šã®æœ€å–„ã‹ã¨å•ã‚ã‚ŒãŸã‚‰ã€Œåˆ†ã‹ã‚‰ãªã„ã€ã¨ã„ã†ã®ãŒå›ç­”ã«ãªã‚Šã¾ã™ã€‚ã‚‚ã£ã¨ã„ã„æ–¹æ³•ãŒã‚ã‚‹ç­‰ã‚ã‚Œã°æ˜¯éæ•™ãˆã¦ã„ãŸã ã‘ã‚Œã°ã¨æ€ã†ã®ã§ã€ã‚ˆã‚ã—ããŠé¡˜ã„ã—ã¾ã™ã€‚

https://twitter.com/uakihir0/status/1711010276869570902
